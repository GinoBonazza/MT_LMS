---
title: "MT_QC_integration_annotation"
author: "GinoBonazza (ginoandrea.bonazza@usz.ch)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---

```{r knitr config, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(warning = FALSE)

knitr::opts_chunk$set(message = FALSE)

knitr::opts_chunk$set(cache = FALSE)

knitr::opts_chunk$set(dpi = 300, fig.align = "center")
```

## Setup

```{r setup, class.source = "fold-hide"}
# Get current file name to make folder
current_file <- "MT_QC_integration_annotation"

# Load libraries
library(here)
library(dplyr)
library(ggplot2)
library(tibble)
library(readr)
library(readxl)
library(knitr)
library(patchwork)
library(scales)

library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)


library(Seurat)
library(DropletUtils)
library(Matrix)
library(scDblFinder)
library(scCustomize)
library(magrittr)
library(tidyverse)
library(reshape2)
library(S4Vectors)
library(SingleCellExperiment)
library(pheatmap)
library(png)
library(gridExtra)
library(Matrix.utils)
library(scater)
library(statmod)
library(clustree)
library(harmony)
library(gprofiler2)
library(AnnotationHub)
library(ReactomePA)
library(speckle)
library(limma)
library(reactable)
library(decoupleR)
library(OmnipathR)
library(dorothea)
library(edgeR)

#Output paths
output_dir_data <- here::here("output", current_file)
if (!dir.exists(output_dir_data)) dir.create(output_dir_data)

if (!dir.exists(here::here("docs", "figure"))) dir.create(here::here("docs", "figure"))

output_dir_figs <- here::here("docs", "figure", paste0(current_file, ".Rmd"))
if (!dir.exists(output_dir_figs)) dir.create(output_dir_figs)
```


## Quality Control

Load and merge cellbender and cellranger output

```{r load data, echo=T, results= "hide"}
cell_bender_merged <- Read_CellBender_h5_Multi_File(merge = TRUE,
                                                    data_dir = here::here("data", "Cellbender_output"),
                                                    custom_name = "_filtered.h5",
                                                    sample_list = c("cellbender_output_Exp1_CMHEF_NC", 
                                                                    "cellbender_output_Exp1_CMHEF_TGF"
                                                                    ),
                                                    sample_names = c("Exp1_CMHEF_NC", 
                                                                     "Exp1_CMHEF_TGF")
                                                    )

cell_ranger_merged <- Read10X_h5_GEO(merge = TRUE,
                                     data_dir = here::here("data", "Cellranger_output"), 
                                     shared_suffix = "_filtered_feature_bc_matrix.h5",
                                     sample_list = c("Exp1_CMHEF_NC", 
                                                     "Exp1_CMHEF_TGF"),
                                     sample_names = c("Exp1_CMHEF_NC", 
                                                      "Exp1_CMHEF_TGF")
                                     )

preQC <- Create_CellBender_Merged_Seurat(raw_cell_bender_matrix = cell_bender_merged, 
                                             raw_counts_matrix = cell_ranger_merged, 
                                             raw_assay_name = "RAW", 
                                             cell_bender_assay_name = "RNA")
rm(cell_bender_merged, cell_ranger_merged)
```

Add metadata: percentage of mitochondrial and ribosomal genes, clinical data

```{r add metadata}
cn <- Cells(preQC)

preQC$Sample <- dplyr::case_when(
  grepl("^Exp1_CMHEF_NC[_-]", cn) ~ "Exp1_CMHEF_NC",
  grepl("^Exp1_CMHEF_TGF[_-]", cn) ~ "Exp1_CMHEF_TGF",
  TRUE ~ NA_character_
)

table(preQC$Sample, useNA = "ifany")

preQC[["percent.mt"]] <- PercentageFeatureSet(preQC, pattern = "^MT-")
preQC[["percent.rp"]] <- PercentageFeatureSet(preQC, pattern = "^RP[SL]")
```

Check how much Cellbender has affected the dataset

```{r Cellbender, fig.height=4, fig.width=7}
table(preQC$Sample)

preQC <- Add_CellBender_Diff(seurat_object = preQC, 
                                 raw_assay_name = "RAW", 
                                 cell_bender_assay_name = "RNA")

median_stats <- Median_Stats(seurat_object = preQC, 
                             group_by_var = "orig.ident", 
                             median_var = c("nCount_Diff", "nFeature_Diff"))
median_stats

feature_diff <- CellBender_Feature_Diff(seurat_object = preQC, 
                                        raw_assay = "RAW", 
                                        cell_bender_assay = "RNA")
head(feature_diff)

CellBender_Diff_Plot(feature_diff_df = feature_diff)
```

Check quality control parameters

```{r QC_pre_VlnPlots, fig.height=6, fig.width=8}
p1 <- VlnPlot(preQC, features = "nCount_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(preQC, features = "nFeature_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(preQC, features = "percent.mt", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(preQC, features = "percent.rp", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

QC_pre_VlnPlots <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_pre_VlnPlots
```

```{r QC_pre_VlnPlots_zoom, fig.height=8, fig.width=8}
p1 <- VlnPlot(preQC, features = "nCount_RNA", group.by = "Sample", pt.size = 0, y.max = 10000) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(preQC, features = "nFeature_RNA", group.by = "Sample", pt.size = 0, y.max = 6000) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(preQC, features = "percent.mt", group.by = "Sample", pt.size = 0, y.max = 25) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(preQC, features = "percent.rp", group.by = "Sample", pt.size = 0, y.max = 20) + theme(axis.title.x = element_blank()) + NoLegend()

QC_pre_VlnPlots_zoom <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_pre_VlnPlots_zoom
```

Doublets detection

```{r}
preQC_sce <- as.SingleCellExperiment(preQC)
preQC_sce <- scDblFinder(preQC_sce, samples="Sample", clusters = TRUE)
table(preQC_sce@colData$scDblFinder.class)
preQC <- as.Seurat(preQC_sce, counts = "counts", data = "logcounts")
rm(preQC_sce)
preQC@meta.data[preQC@meta.data$scDblFinder.class %in% "singlet", "scDblFinder.n"] = paste0("Singlets (n=", table(preQC$scDblFinder.class)[1], ")")
preQC@meta.data[preQC@meta.data$scDblFinder.class %in% "doublet", "scDblFinder.n"] = paste0("Doublets (n=", table(preQC$scDblFinder.class)[2], ")")
preQC$scDblFinder.n <- factor(x = preQC$scDblFinder.n, levels = c(rownames(table(preQC$scDblFinder.n))[2], rownames(table(preQC$scDblFinder.n))[1])) 
```

```{r QC_pre_Doublets, fig.height=3, fig.width=8}
p1 <- VlnPlot(preQC, features = c("nCount_RNA"), split.by = "scDblFinder.n", group.by = "Sample", pt.size = 0, y.max = 50000) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(preQC, features = c("nFeature_RNA"), split.by = "scDblFinder.n", group.by = "Sample", pt.size = 0, y.max = 10000) + theme(axis.title.x = element_blank()) 

QC_pre_Doublets <- p1 + p2 + plot_layout(ncol = 2)

QC_pre_Doublets
```

```{r eval=FALSE}
saveRDS(preQC, 
        here::here(output_dir_data, "MT_preQC.rds"))
```

Remove doublets

```{r preQC_no_doublets}
preQC_no_doublets <- subset(x = preQC, subset = scDblFinder.class == "singlet")
table(preQC_no_doublets@meta.data$scDblFinder.class)
rm(preQC)
```

Check quality control parameters after removing doublets

```{r QC_pre_no_doublets_VlnPlots, fig.height=6, fig.width=8}
p1 <- VlnPlot(preQC_no_doublets, features = "nCount_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(preQC_no_doublets, features = "nFeature_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(preQC_no_doublets, features = "percent.mt", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(preQC_no_doublets, features = "percent.rp", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

QC_pre_no_doublets_VlnPlots <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_pre_no_doublets_VlnPlots
```

```{r QC_pre_no_doublets_VlnPlots_zoom, fig.height=10, fig.width=8}
p1 <- VlnPlot(preQC_no_doublets, features = "nCount_RNA", group.by = "Sample", pt.size = 0, y.max = 10000) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(preQC_no_doublets, features = "nFeature_RNA", group.by = "Sample", pt.size = 0, y.max = 6000) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(preQC_no_doublets, features = "percent.mt", group.by = "Sample", pt.size = 0, y.max = 25) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(preQC_no_doublets, features = "percent.rp", group.by = "Sample", pt.size = 0, y.max = 20) + theme(axis.title.x = element_blank()) + NoLegend()

QC_pre_no_doublets_VlnPlots_zoom <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_pre_no_doublets_VlnPlots_zoom
```

Filter based on number of counts, features and percentage of mitochondrial genes

```{r}
postQC <- subset(preQC_no_doublets, subset = 
                nFeature_RNA > 300 &
                percent.mt < 20 &
                nCount_RNA > 500)

table(postQC$Sample)
```

Check quality control parameters

```{r QC_post_VlnPlots, fig.height=6, fig.width=8}
p1 <- VlnPlot(postQC, features = "nCount_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(postQC, features = "nFeature_RNA", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(postQC, features = "percent.mt", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(postQC, features = "percent.rp", group.by = "Sample", pt.size = 0) + theme(axis.title.x = element_blank()) + NoLegend()

QC_post_VlnPlots <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_post_VlnPlots
```

```{r QC_post_VlnPlots_zoom, fig.height=6, fig.width=8}
p1 <- VlnPlot(postQC, features = "nCount_RNA", group.by = "Sample", pt.size = 0, y.max = 10000) + theme(axis.title.x = element_blank()) + NoLegend()

p2 <- VlnPlot(postQC, features = "nFeature_RNA", group.by = "Sample", pt.size = 0, y.max = 6000) + theme(axis.title.x = element_blank()) + NoLegend()

p3 <- VlnPlot(postQC, features = "percent.mt", group.by = "Sample", pt.size = 0, y.max = 25) + theme(axis.title.x = element_blank()) + NoLegend()

p4 <- VlnPlot(postQC, features = "percent.rp", group.by = "Sample", pt.size = 0, y.max = 20) + theme(axis.title.x = element_blank()) + NoLegend()

QC_post_VlnPlots_zoom <- p1 + p2 + p3 + p4 + plot_layout(ncol = 2)

QC_post_VlnPlots_zoom
```

## Integration and clustering

Normalization and scaling using SCTransform.

```{r SCTransform, message=FALSE, warning=FALSE}
DefaultAssay(postQC) <- "RNA"
postQC <- SplitObject(postQC, split.by = "Sample")
for (i in 1:length(postQC)) {
  postQC[[i]] <- SCTransform(postQC[[i]], 
                             vst.flavor = "v2", 
                             vars.to.regress = c("percent.mt"), 
                             return.only.var.genes = TRUE,
                             method = "glmGamPoi")
}
```

PCA without integration

```{r, eval=FALSE}
features <- SelectIntegrationFeatures(object.list = postQC, nfeatures = 2000)
not_integrated <- Merge_Seurat_List(postQC)
VariableFeatures(not_integrated) <- features
not_integrated <- RunPCA(not_integrated)
```

```{r eval=FALSE}
saveRDS(not_integrated, 
        here::here(output_dir_data, "MT_not_integrated.rds"))
```

```{r}
not_integrated <- readRDS(here::here(output_dir_data, "MT_not_integrated.rds"))
```


```{r Elbow_not_integrated, fig.width=4, fig.height=4}
ElbowPlot(not_integrated, ndims = 50)
```

Clustering without integration

```{r eval=FALSE}
not_integrated <- RunUMAP(not_integrated, dims = 1:30)
not_integrated <- FindNeighbors(not_integrated, dims = 1:30)
not_integrated <- FindClusters(not_integrated, resolution = seq(0.1, 0.8, by=0.1))
```

```{r Clustree_not_integrated, fig.width=6, fig.height=9}
clustree::clustree(not_integrated@meta.data[,grep("SCT_snn_res", colnames(not_integrated@meta.data))],
                   prefix = "SCT_snn_res.")
```

```{r UMAPs_not_integrated, fig.width=12, fig.height=10}
DimPlot(not_integrated, reduction = "umap", shuffle = T,
        group.by = c("SCT_snn_res.0.2", "SCT_snn_res.0.3", "SCT_snn_res.0.4", "Sample"), ncol = 2)
```

```{r eval=FALSE}
saveRDS(not_integrated, 
        here::here(output_dir_data, "MT_not_integrated.rds"))
```

Integrate the samples

```{r RunHarmony}
integrated <- RunHarmony(not_integrated, 
                     assay.use="SCT", 
                     group.by.vars = "Sample", 
                     dims.use = 1:30, 
                     plot_convergence=TRUE, 
                     .options = harmony_options(
                       max.iter.cluster = 100,
                       )
                     )
```

```{r, eval=FALSE}
saveRDS(integrated, 
        here::here(output_dir_data, "MT.rds"))
```

```{r}
integrated <- readRDS(here::here(output_dir_data, "MT.rds"))
```

Clustering after integration

```{r eval=FALSE}
integrated <- RunUMAP(integrated, dims = 1:30, reduction = "harmony")
integrated <- FindNeighbors(integrated, dims = 1:30, reduction = "harmony")
integrated <- FindClusters(integrated, resolution = seq(0.1, 0.8, by=0.1))
```

```{r Clustree_integrated, fig.width=6, fig.height=9}
clustree::clustree(integrated@meta.data[,grep("SCT_snn_res", colnames(integrated@meta.data))],
                   prefix = "SCT_snn_res.")
```

```{r UMAPs_integrated, fig.width=12, fig.height=10}
DimPlot(integrated, reduction = "umap", shuffle = T,
        group.by = c("SCT_snn_res.0.2", "SCT_snn_res.0.3", "SCT_snn_res.0.4", "Sample"), ncol = 2)
```

Find the markers that characterize each cell population

```{r}
DefaultAssay(integrated) <- "RNA"
integrated <- NormalizeData(integrated)
Idents(integrated) <- "SCT_snn_res.0.2"
Markers <- FindAllMarkers(integrated, only.pos = TRUE, min.pct = 0.5, logfc.threshold = 0.5)
write.csv(Markers, here::here(output_dir_data, "MT_Markers_all.csv"))
Markers_top10 <- as.data.frame(Markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC))
write.csv(Markers_top10, here::here(output_dir_data, "MT_Markers_top10.csv"))
Markers_top3 <- as.data.frame(Markers %>% group_by(cluster) %>% top_n(n = 3, wt = avg_log2FC))
write.csv(Markers_top3, here::here(output_dir_data, "MT_Markers_top3.csv"))
```


Check QC parameters in each cluster

```{r QC_VlnPlots, fig.width=10, fig.height=6}
VlnPlot(integrated, features = c("nCount_RNA", "nFeature_RNA", "percent.mt", "percent.rp"), ncol = 2) + theme(axis.title.x = element_blank())
```

Check cell cycle genes

```{r Cell_cycle_UMAP, fig.width=5, fig.height=4}
DefaultAssay(integrated) <- "RNA"
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
integrated <- CellCycleScoring(integrated, s.features = s.genes, g2m.features = g2m.genes)
DimPlot(integrated, reduction = "umap", shuffle = T,
        group.by = "Phase")
```


## Cell type annotation

Annotate the clusters based on the characteristic markers

```{r}
integrated@meta.data[integrated@meta.data$SCT_snn_res.0.2 %in% c("0"), "cell_type"] = "Cardiomyocytes I"
integrated@meta.data[integrated@meta.data$SCT_snn_res.0.2 %in% c("1"), "cell_type"] = "Fibroblasts"
integrated@meta.data[integrated@meta.data$SCT_snn_res.0.2 %in% c("2"), "cell_type"] = "Cardiomyocytes II"
integrated@meta.data[integrated@meta.data$SCT_snn_res.0.2 %in% c("3"), "cell_type"] = "Proliferating cells"
integrated$cell_type <- factor(integrated$cell_type, levels = c("Cardiomyocytes I", 
                                                                        "Fibroblasts",
                                                                        "Cardiomyocytes II",
                                                                        "Proliferating cells"))
Idents(integrated) <- integrated$cell_type
```

```{r Heatmap, fig.width=12, fig.height=10}
integrated <- ScaleData(integrated)
mapal <- colorRampPalette(RColorBrewer::brewer.pal(9,"RdBu"))(256)
mapal <- rev(mapal[1:256])
cluster_palette <- c("#F8766D","#24B700", "#00ACFC", "#D575FE")
Heatmap <- DoHeatmap(integrated, draw.line = F, features = Markers_top10$gene, group.colors = cluster_palette) +
  guides(colour=FALSE) +
  scale_fill_gradientn(colours = mapal) +
  theme(text = element_text(size = 15), axis.text.y = element_text(size = 8)) +
  theme(plot.margin = unit(c(0.1, 0, 0, 0), 
                           "inches"))
Heatmap
```

```{r UMAP_cell_type, fig.width=6.5, fig.height=6}
p <- DimPlot(integrated, group.by = "cell_type", reduction = "umap", label = F, cols = cluster_palette) + 
  NoLegend() + 
  theme(axis.text=element_text(size=14, face = "bold"), axis.title = element_text(size = 18, face = "bold")) + 
  theme(plot.title = element_blank())
LabelClusters(p, id = "cell_type", fontface = "bold", size = 5.5, repel = T)
```

```{r DotPlot_markers, fig.width=6, fig.height=7}
DotPlot(integrated, assay = "SCT", features = rev(Markers_top3$gene), dot.scale = 5, cluster.idents = FALSE) +
  RotatedAxis() +
  coord_flip() +
  theme(axis.title = element_blank(), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 13), legend.text = element_text(size = 9), legend.title = element_text(size = 11), plot.margin = unit(c(0, 0, 0, 0.1), 
                           "inches"))
```

```{r DotPlot_markers_2, fig.width=10, fig.height=5}
Markers_top5 <- as.data.frame(Markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC))
Idents(integrated) <- factor(integrated$cell_type, levels = rev(levels(integrated$cell_type)))
DotPlot(integrated, assay = "SCT", features = Markers_top5$gene, dot.scale = 5) +
  RotatedAxis() +
  theme(axis.title = element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 13), legend.text = element_text(size = 9), legend.title = element_text(size = 11), plot.margin = unit(c(0, 0, 0, 0.1), 
                           "inches"))
```

```{r FeatPlot_markers, fig.width=16, fig.height=4}
FeaturePlot_scCustom(integrated, features = c("EMC10", "COL3A1", "TNNC1", "TOP2A"), num_columns = 4)
```

```{r FeatPlot_markers_2, fig.width=16, fig.height=4}
FeaturePlot_scCustom(integrated, features = c("nCount_RNA", "nFeature_RNA", "percent.mt", "percent.rp"), num_columns = 4)
```

```{r FeatPlot_markers_3, fig.width=16, fig.height=12}
FeaturePlot_scCustom(integrated, features = c("RYR2", "FGF12", "COL1A1", "FN1", "VWF", "PECAM1", "MKI67", "TOP2A", "nCount_RNA", "nFeature_RNA", "percent.mt", "percent.rp"), num_columns = 4)
```

```{r FeatPlot_markers_4, fig.width=16, fig.height=12}
FeaturePlot_scCustom(integrated, features = c("RYR2", "FGF12", "COL1A1", "FN1", "VWF", "PECAM1", "MKI67", "TOP2A", "nCount_RNA", "nFeature_RNA", "percent.mt", "percent.rp"), num_columns = 4, order = F)
```

```{r FeatPlot_markers_5, fig.width=16, fig.height=12}
FeaturePlot_scCustom(integrated, features = c("VWF", "CDH5", "PECAM1", "CD34", "ESAM", "ANO2", "KDR", "FLT1", "RAMP2", "ENG", "ROBO4", "EMCN", "CD36", "SLC9A3R2"), num_columns = 4, order = F)
```

```{r, fig.height=6, fig.width=12}
genes_score <- c("VWF", "CDH5", "PECAM1", "CD34", "ESAM", "ANO2", "KDR", "RAMP2", "ROBO4", "EMCN")

integrated <- AddModuleScore(
  object   = integrated,
  features = list(genes_score),
  name     = "EC score"
)
integrated$`EC score` <- integrated$`EC score1`
integrated$`EC score1` <- NULL

FeaturePlot_scCustom(
  integrated,
  features = "EC score",
  reduction = "umap",
  order = F
)
FeaturePlot_scCustom(
  integrated,
  features = "EC score",
  reduction = "umap",
  order = T, na_cutoff = 0.5,
  split.by="Sample"
)

integrated[[]] %>%
  mutate(EC_high = (`EC score` > 0.5)) %>%
  group_by(Sample) %>%
  summarise(
    n_cells = n(),
    n_EC_high = sum(EC_high, na.rm = TRUE),
    frac_EC_high = n_EC_high / n_cells
  )

```

```{r FindAllMarkers cell_type}
DefaultAssay(integrated) <- "RNA"
Idents(integrated) <- "cell_type"
Markers <- FindAllMarkers(integrated, only.pos = TRUE, min.pct = 0.5, logfc.threshold = 0.5)
write.csv(Markers, here::here(output_dir_data, "MT_Markers_all_cell_type.csv"))
Markers_top10 <- as.data.frame(Markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC))
write.csv(Markers_top10, here::here(output_dir_data, "MT_Markers_top10_cell_type.csv"))
Markers_top3 <- as.data.frame(Markers %>% group_by(cluster) %>% top_n(n = 3, wt = avg_log2FC))
write.csv(Markers_top3, here::here(output_dir_data, "MT_Markers_top3_cell_type.csv"))
```

```{r}
df <- Markers[,7:6]
dfsample <- split(df$gene,df$cluster)
length(dfsample)

dfsample$`Cardiomyocytes I` = bitr(dfsample$`Cardiomyocytes I`, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
dfsample$`Fibroblasts` = bitr(dfsample$`Fibroblasts`, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
dfsample$`Cardiomyocytes II` = bitr(dfsample$`Cardiomyocytes II`, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
dfsample$`Proliferating cells` = bitr(dfsample$`Proliferating cells`, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

#do the same here, a line like below for each cluster
genelist <- list("Cardiomyocytes I" = dfsample$`Cardiomyocytes I`$ENTREZID, 
                 "Fibroblasts" = dfsample$`Fibroblasts`$ENTREZID,
                 "Cardiomyocytes II" = dfsample$`Cardiomyocytes II`$ENTREZID,
                 "Proliferating cells" = dfsample$`Proliferating cells`$ENTREZID
)

# Calculate gene counts across cells
gene_counts <- rowSums(integrated@assays$RNA@counts > 0)

# Filter genes to include only those expressed in at least 3 cells
universe_genes <- names(gene_counts[gene_counts >= 3])

# Convert universe gene symbols to Entrez IDs
universe_entrez <- bitr(universe_genes, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)$ENTREZID
```

```{r Pathways_GO_MF, fig.height=8, fig.width=8}
GO_MF <- compareCluster(geneCluster = genelist, fun = "enrichGO", ont = "ALL",  OrgDb = "org.Hs.eg.db", universe = universe_entrez)
GO_MF <- gsfilter(GO_MF, by = 'Count', min = 3)
dotplot(GO_MF, label_format = 35, title = "GO Over-representation analysis") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r Pathways_GO_MF_simplified, fig.height=8, fig.width=8}
GO_MF_simplified <- clusterProfiler::simplify(
  GO_MF,
  cutoff = 0.7,
  by = "p.adjust",
  select_fun = min,
  measure = "Wang",
  semData = NULL
)
dotplot(GO_MF_simplified, label_format = 40, title = "Over-representation analysis") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r Barplot_Sample, fig.height=5, fig.width=6, message=FALSE}
props <- getTransformedProps(
  integrated$cell_type,
  integrated$Sample,
  transform = "logit"
)

df <- as.data.frame(props$Proportions) %>%
  dplyr::rename(
    cell_type   = clusters,
    Sample      = sample,
    Proportion  = Freq
  )

p <- ggplot(df, aes(x = Sample, y = Proportion, fill = cell_type)) +
  geom_col(
    width = 0.8,
    color = "black",      # black borders
    linewidth = 0.5       # thin, publication-style
  ) +
  scale_fill_manual(values = cluster_palette) +
  labs(y = "Proportions", x = NULL) +
  theme_classic(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, face = "bold"),
    axis.title.y = element_text(face = "bold"),
    legend.position = "right",
    legend.title = element_blank()
  )

p
```

```{r Cell_type_sample_table, fig.height=3, fig.width=8, message=FALSE, warning=FALSE}
metadata <- integrated@meta.data

cell_type_sample_table <- table(metadata$cell_type, metadata$Sample)
cell_type_sample_df <- as.data.frame.matrix(cell_type_sample_table)

cell_type_sample_df["Total", ] <- colSums(cell_type_sample_df)
cell_type_sample_df$Total <- rowSums(cell_type_sample_df)

library(gridExtra)
library(grid)

table_plot <- tableGrob(cell_type_sample_df)

grid.newpage()
grid.draw(table_plot)
```

```{r, eval = FALSE}
integrated@assays[["RAW"]] <- NULL
saveRDS(integrated, 
        here::here(output_dir_data, "MT.rds"))
```

